<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roadmap del Proyecto ‚Äì M√°s Vida</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 20px;
    transition: background-color 0.3s, color 0.3s;
  }

  body.dark-mode {
    background-color: #1a1a1a;
    color: #e0e0e0;
  }

  h1 {
    text-align: center;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
  }

  body.dark-mode h1 {
    color: #e0e0e0;
  }

  .theme-toggle {
    background: none;
    border: 2px solid #333;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .theme-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }

  body.dark-mode .theme-toggle {
    border-color: #e0e0e0;
  }

  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
  }

  body.dark-mode .tabs {
    border-bottom-color: #444;
  }

  .tab {
    padding: 10px 20px;
    background-color: #e9ecef;
    border: none;
    border-radius: 5px 5px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  body.dark-mode .tab {
    background-color: #2a2a2a;
    color: #e0e0e0;
  }

  .tab.active {
    background-color: #fff;
    border-bottom: 2px solid #fff;
    margin-bottom: -2px;
  }

  body.dark-mode .tab.active {
    background-color: #333;
    border-bottom-color: #333;
  }

  .tab:hover {
    background-color: #dee2e6;
  }

  body.dark-mode .tab:hover {
    background-color: #3a3a3a;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  #formContainer {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  body.dark-mode #formContainer {
    background: #2a2a2a;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }

  label {
    font-weight: bold;
  }

  input, select, button {
    margin: 5px 10px 10px 0;
    padding: 6px;
  }

  .btn-add {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
  }

  .btn-add:hover { background-color: #218838; }
  .btn-delete { background-color: #dc3545; color: white; }
  .btn-cancel { background-color: #6c757d; color: white; }
  .btn-save-view { background-color: #007bff; color: white; }

  .controls {
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .table-container {
    max-height: 500px;
    overflow-y: auto;
    background: white;
    border-radius: 5px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
    font-size: 13px;
  }

  .bar {
    height: 20px;
    border-radius: 4px;
  }

  .legend { margin-top: 15px; }
</style>
</head>
<body>

<h1>
  Roadmap del Proyecto ‚Äì M√°s Vida
  <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Cambiar tema">
    üåô
  </button>
</h1>

<div class="tabs">
  <button class="tab active" onclick="switchTab('roadmap')">Roadmap</button>
  <button class="tab" onclick="switchTab('vistas')">Vistas Guardadas</button>
  <button class="tab" onclick="switchTab('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
</div>

<div id="roadmapTab" class="tab-content active">
  <div id="formContainer">
    <label>M√≥dulo:</label><input type="text" id="modulo">
    <label>Sprint inicio:</label><input type="number" id="sprint" min="1" max="24" style="width:60px;">
    <label>Duraci√≥n:</label><input type="number" id="duracion" min="1" max="24" style="width:60px;">
    <label>Estado:</label><select id="estado"></select>
    <button class="btn-add" id="btnAgregar">Agregar / Actualizar</button>
    <button class="btn-delete" id="btnEliminar" style="display:none;">Eliminar</button>
    <button class="btn-cancel" id="btnCancelar" style="display:none;">Cancelar</button>
  </div>

  <div class="controls">
    <button class="btn-save-view" onclick="guardarVistaModal()">üíæ Guardar Vista</button>
    <button class="btn-save-view" onclick="exportarGrillaPNG()">üìä Exportar PNG</button>
  </div>

  <div id="captureArea">
    <div class="table-container">
      <table id="ganttTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="legend">
      <strong>Leyenda:</strong>
      <div id="legendaEstados"></div>
    </div>
  </div>
</div>

<div id="vistasTab" class="tab-content">
  <h2>Vistas Guardadas</h2>
  <div id="vistasList"></div>
</div>

<div id="configuracionTab" class="tab-content">
  <h3>Gesti√≥n de Estados</h3>
  <div id="estadosConfigList"></div>
  <button class="btn-add" onclick="agregarNuevoEstado()">‚ûï Agregar Estado</button>

  <h3>Configuraci√≥n de Sprints / Meses</h3>
  <label>Cantidad de Sprints:</label>
  <input type="number" id="cantidadSprints" min="1" max="24" style="width:80px;">
  <button class="btn-add" onclick="actualizarCantidadSprints()">Actualizar</button>

  <div id="mesesConfigList"></div>
</div>
<script>
let data = [];
let estados = [];
let meses = [];
let cantidadSprints = 16;
let vistas = [];
let collapsedColumns = { sprint: false, duracion: false }; // Mantiene esta funcionalidad igual

const THEME_KEY = 'ganttTheme'; // Tema queda local

// -------------------------
// 1) Cargar todo desde backend
// -------------------------
async function loadAllFromServer() {
  try {
    const response = await fetch("/load");
    const json = await response.json();

    data = json.data || [];
    estados = json.estados || getDefaultEstados();
    meses = json.meses || getDefaultMeses();
    cantidadSprints = json.cantidadSprints || 16;
    vistas = json.vistas || [];

    actualizarSelectEstados();
    actualizarEstilosEstados();
    actualizarLeyenda();
    renderGantt();
    renderVistasList();
    renderEstadosConfig();
    renderMesesConfig();

  } catch (err) {
    console.error("Error cargando datos del servidor:", err);
    alert("‚ö†Ô∏è No se pudo cargar datos del servidor.");
  }
}

// -------------------------
// 2) Guardar TODO en backend
// -------------------------
async function saveAll() {
  const payload = {
    data,
    estados,
    meses,
    cantidadSprints,
    vistas
  };

  try {
    await fetch("/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.error("Error guardando:", err);
    alert("‚ö†Ô∏è Error al guardar los cambios.");
  }
}

// -------------------------
// Estados por defecto (igual que antes)
// -------------------------
function getDefaultEstados() {
  return [
    { id: 'done', nombre: 'Completado', color: '#4caf50' },
    { id: 'in-progress', nombre: 'En progreso', color: '#2196f3' },
    { id: 'pending', nombre: 'Pendiente', color: '#ff9800' },
    { id: 'future', nombre: 'Futuro', color: '#9e9e9e' }
  ];
}

// -------------------------
// Meses por defecto
// -------------------------
function getDefaultMeses() {
  return [
    'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov',
    'Dic', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'
  ];
}

// -------------------------
// Tema (queda en localStorage)
// -------------------------
function loadTheme() {
  const savedTheme = localStorage.getItem(THEME_KEY);
  const themeToggle = document.getElementById('themeToggle');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
    themeToggle.textContent = '‚òÄÔ∏è';
  } else themeToggle.textContent = 'üåô';
}

function toggleTheme() {
  const themeToggle = document.getElementById('themeToggle');
  document.body.classList.toggle('dark-mode');
  themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem(THEME_KEY, document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

// Inicializaci√≥n
loadTheme();
loadAllFromServer();
/**************************************
 * TABLA GANTT + FORMULARIO PRINCIPAL *
 **************************************/

function renderGantt() {
  const tbody = document.querySelector("#ganttTable tbody");
  const thead = document.querySelector("#ganttTable thead");

  thead.innerHTML = `
    <tr>
      <th rowspan="2">M√≥dulo</th>
      <th rowspan="2" class="collapsible-header col-sprint" id="headerSprint">Sprint</th>
      <th rowspan="2" class="collapsible-header col-duracion" id="headerDuracion">Duraci√≥n</th>
      <th colspan="${cantidadSprints}">Timeline</th>
    </tr>
    <tr>
      ${meses.slice(0, cantidadSprints).map(m => `<th>${m}</th>`).join("")}
    </tr>
    <tr>
      <th></th>
      <th class="col-sprint">S</th>
      <th class="col-duracion">D</th>
      ${Array.from({length: cantidadSprints}, (_, i) => `<th>S${i+1}</th>`).join("")}
    </tr>
  `;

  // Re-asociamos eventos para contraer/expandir columnas
  document.getElementById("headerSprint").onclick = () => toggleColumn('sprint');
  document.getElementById("headerDuracion").onclick = () => toggleColumn('duracion');

  tbody.innerHTML = "";
  data.forEach((item, index) => {
    const tr = document.createElement("tr");
    tr.draggable = true;
    tr.dataset.index = index;
    tr.innerHTML = `
      <td>${item.modulo}</td>
      <td class="col-sprint">${item.sprint}</td>
      <td class="col-duracion">${item.duracion}</td>
    `;

    for (let i = 1; i <= cantidadSprints; i++) {
      const td = document.createElement("td");
      if (i >= item.sprint && i < item.sprint + item.duracion) {
        td.innerHTML = `<div class="bar" style="background:${getColorEstado(item.estado)}" title="${item.estado}"></div>`;
      }
      tr.appendChild(td);
    }

    tr.onclick = () => editarFila(item);
    tr.addEventListener("dragstart", handleDragStart);
    tr.addEventListener("dragover", handleDragOver);
    tr.addEventListener("drop", handleDrop);
    tr.addEventListener("dragend", handleDragEnd);

    tbody.appendChild(tr);
  });

  applyColumnState();
  actualizarLeyenda();
}

// ---------------------
// Obtener color del estado
// ---------------------
function getColorEstado(idEstado) {
  const estado = estados.find(e => e.id === idEstado);
  return estado ? estado.color : "#999";
}

// ---------------------
// Agregar / Actualizar m√≥dulo
// ---------------------
let moduloEditando = null;

function agregarFila() {
  const modulo = document.getElementById("modulo").value.trim();
  const sprint = parseInt(document.getElementById("sprint").value);
  const duracion = parseInt(document.getElementById("duracion").value);
  const estado = document.getElementById("estado").value;

  if (!modulo || isNaN(sprint) || isNaN(duracion)) {
    alert("Completa todos los campos.");
    return;
  }

  const existente = data.find(d => d.modulo === moduloEditando || d.modulo === modulo);

  if (existente) {
    existente.modulo = modulo;
    existente.sprint = sprint;
    existente.duracion = duracion;
    existente.estado = estado;
  } else {
    data.push({ modulo, sprint, duracion, estado });
  }

  moduloEditando = null;
  limpiarFormulario();
  saveAll();
  renderGantt();
}

// ---------------------
// Editar fila
// ---------------------
function editarFila(item) {
  moduloEditando = item.modulo;
  document.getElementById("modulo").value = item.modulo;
  document.getElementById("sprint").value = item.sprint;
  document.getElementById("duracion").value = item.duracion;
  document.getElementById("estado").value = item.estado;

  document.getElementById("btnEliminar").style.display = "inline-block";
  document.getElementById("btnCancelar").style.display = "inline-block";
}

function eliminarFila() {
  if (!moduloEditando) return;
  data = data.filter(item => item.modulo !== moduloEditando);
  moduloEditando = null;
  limpiarFormulario();
  saveAll();
  renderGantt();
}

function cancelarEdicion() { limpiarFormulario(); }

function limpiarFormulario() {
  moduloEditando = null;
  document.getElementById("modulo").value = "";
  document.getElementById("sprint").value = "";
  document.getElementById("duracion").value = "";
  document.getElementById("estado").value = estados[0].id;
  document.getElementById("btnEliminar").style.display = "none";
  document.getElementById("btnCancelar").style.display = "none";
}

// ---------------------
// Drag & Drop
// ---------------------
let draggedRow = null;

function handleDragStart(e) {
  draggedRow = this;
  this.classList.add("dragging");
}

function handleDragOver(e) { e.preventDefault(); }

function handleDrop() {
  const draggedIndex = parseInt(draggedRow.dataset.index);
  const targetIndex = parseInt(this.dataset.index);
  const [moved] = data.splice(draggedIndex, 1);
  data.splice(targetIndex, 0, moved);
  saveAll();
  renderGantt();
}

function handleDragEnd() {
  this.classList.remove("dragging");
}

// ---------------------
// Columnas colapsables
// ---------------------
function toggleColumn(col) {
  collapsedColumns[col] = !collapsedColumns[col];
  applyColumnState();
}

function applyColumnState() {
  document.querySelectorAll(".col-sprint").forEach(el => el.style.display = collapsedColumns.sprint ? "none" : "");
  document.querySelectorAll(".col-duracion").forEach(el => el.style.display = collapsedColumns.duracion ? "none" : "");
}
/**************************************
 * CONFIGURACI√ìN DE ESTADOS
 **************************************/
function renderEstadosConfig() {
  const container = document.getElementById("estadosConfigList");
  container.innerHTML = "";

  estados.forEach((estado, i) => {
    container.innerHTML += `
      <div class="estado-config">
        <input type="text" value="${estado.nombre}" onchange="actualizarEstadoNombre(${i}, this.value)">
        <input type="color" value="${estado.color}" onchange="actualizarEstadoColor(${i}, this.value)">
        <div class="estado-preview" style="background:${estado.color}">${estado.nombre}</div>
        <button class="btn-delete" onclick="eliminarEstado(${i})">Eliminar</button>
      </div>`;
  });

  actualizarSelectEstados();
  actualizarEstilosEstados();
}

function actualizarEstadoNombre(i, nuevo) {
  estados[i].nombre = nuevo.trim();
  saveAll();
  renderEstadosConfig();
  renderGantt();
}

function actualizarEstadoColor(i, nuevo) {
  estados[i].color = nuevo;
  saveAll();
  renderEstadosConfig();
  renderGantt();
}

function eliminarEstado(i) {
  if (estados.length <= 1) return alert("Debe haber al menos un estado.");
  estados.splice(i, 1);
  data.forEach(item => { if (!estados.find(e => e.id === item.estado)) item.estado = estados[0].id });
  saveAll();
  renderEstadosConfig();
  renderGantt();
}

function agregarNuevoEstado() {
  const nombre = prompt("Nombre del estado:");
  if (!nombre) return;
  estados.push({ id: `estado-${Date.now()}`, nombre, color: "#888888" });
  saveAll();
  renderEstadosConfig();
}

/**************************************
 * CONFIGURACI√ìN DE MESES / SPRINTS
 **************************************/
function renderMesesConfig() {
  const cont = document.getElementById("mesesConfigList");
  document.getElementById("cantidadSprints").value = cantidadSprints;
  cont.innerHTML = "";

  for (let i = 0; i < cantidadSprints; i++) {
    cont.innerHTML += `
      <div class="mes-config">
        <label>Sprint ${i+1}:</label>
        <input type="text" value="${meses[i] || ""}" onchange="actualizarNombreMes(${i}, this.value)">
      </div>`;
  }
}

function actualizarNombreMes(i, nuevo) {
  meses[i] = nuevo.trim();
  saveAll();
  renderGantt();
}

function actualizarCantidadSprints() {
  const nuevaCantidad = parseInt(document.getElementById("cantidadSprints").value);
  if (nuevaCantidad < 1 || nuevaCantidad > 24) return alert("Cantidad entre 1 y 24.");

  cantidadSprints = nuevaCantidad;
  while (meses.length < cantidadSprints) meses.push("Mes");
  while (meses.length > cantidadSprints) meses.pop();

  data.forEach(item => {
    if (item.sprint > cantidadSprints) item.sprint = cantidadSprints;
    if (item.sprint + item.duracion - 1 > cantidadSprints) item.duracion = 1;
  });

  saveAll();
  renderMesesConfig();
  renderGantt();
}

/**************************************
 * VISTAS GUARDADAS
 **************************************/
function guardarVistaModal() {
  const nombre = prompt("Nombre de la vista:");
  if (!nombre) return;
  vistas.push({
    id: Date.now(),
    nombre,
    fecha: new Date().toLocaleString('es-AR'),
    data: structuredClone(data),
    estados: structuredClone(estados),
    meses: structuredClone(meses),
    cantidadSprints
  });
  saveAll();
  renderVistasList();
  alert("Vista guardada ‚úÖ");
}

function renderVistasList() {
  const cont = document.getElementById("vistasList");
  cont.innerHTML = vistas.length === 0 ? 
    "<p>No hay vistas guardadas.</p>" :
    vistas.map(v => `
      <div class="view-item">
        <div class="view-name">${v.nombre}</div>
        <div class="view-date">${v.fecha}</div>
        <div class="view-actions">
          <button class="btn-add" onclick="cargarVista(${v.id})">Cargar</button>
          <button class="btn-delete" onclick="eliminarVista(${v.id})">Eliminar</button>
        </div>
      </div>
    `).join("");
}

function cargarVista(id) {
  const v = vistas.find(v => v.id === id);
  if (!v) return;
  data = structuredClone(v.data);
  estados = structuredClone(v.estados);
  meses = structuredClone(v.meses);
  cantidadSprints = v.cantidadSprints;
  saveAll();
  renderGantt();
  renderEstadosConfig();
  renderMesesConfig();
}

function eliminarVista(id) {
  vistas = vistas.filter(v => v.id !== id);
  saveAll();
  renderVistasList();
}

/**************************************
 * EXPORTAR PNG
 **************************************/
function exportarGrillaPNG() {
  const area = document.getElementById("captureArea");
  html2canvas(area, { scale: 2 }).then(canvas => {
    const link = document.createElement("a");
    link.download = "roadmap.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

/**************************************
 * PESTA√ëAS
 **************************************/
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove("active"));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove("active"));
  if (tab === "roadmap") document.querySelector('.tab:nth-child(1)').classList.add("active"), document.getElementById("roadmapTab").classList.add("active");
  if (tab === "vistas") document.querySelector('.tab:nth-child(2)').classList.add("active"), document.getElementById("vistasTab").classList.add("active"), renderVistasList();
  if (tab === "configuracion") document.querySelector('.tab:nth-child(3)').classList.add("active"), document.getElementById("configuracionTab").classList.add("active"), renderEstadosConfig(), renderMesesConfig();
}

/**************************************
 * FIN SCRIPT
 **************************************/
</script>
</body>
</html>
